<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Mongodb 监测 | Yizhou&#39;s Website</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="介绍 🔗为什么要进行监控状态，因为在实际的情况中可能会发生一下无法预计的情况，比如阻塞的问题，阻塞的原因会有很多种情况造成，如果当我们查询文档">
<meta name="generator" content="Hugo 0.121.1">


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/css/style.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />




  





    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          "HTML-CSS": { scale: 85 },
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            processEscapes: true
          }
        });
    </script>
    
    <script src='https://cdn.jsdelivr.net/npm/mathjax@2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>





  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">←</span>首页</a>
	
	<a href="/posts">归档</a>
	<a href="/tags">标签</a>
	<a href="/about">关于</a>

	

	
	  <a class="button" href="https://wuyizhou.com/index.xml">订阅</a>
	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">Mongodb 监测</h1>

    <div class="tip">
        <time datetime="2017-08-25 13:14:20 &#43;0000 UTC">2017年08月25日</time>
        <span class="split">
          ·
        </span>
        <span>
          1719字
        </span>
        <span class="split">
          ·
        </span>
        <span>
          4分钟
        </span>
    </div>

    
    
        
  
    <aside class="toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#介绍">介绍</a></li>
    <li><a href="#mongodb自带监控工具">Mongodb自带监控工具</a>
      <ul>
        <li><a href="#mongostat">mongostat</a></li>
        <li><a href="#mongotop">mongotop</a></li>
      </ul>
    </li>
    <li><a href="#数据库命令">数据库命令</a>
      <ul>
        <li><a href="#dbcurrentop">db.currentOp</a></li>
        <li><a href="#dbserverstatus">db.serverStatus</a></li>
        <li><a href="#dbstats-dbteststats-rsstatus">db.stats db.test.stats rs.status</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
          </div>
      </details>
    </aside>
  


    


    <div class="content">
      <h2 id="介绍">介绍 <a href="#%e4%bb%8b%e7%bb%8d" class="anchor">🔗</a></h2><p>为什么要进行监控状态，因为在实际的情况中可能会发生一下无法预计的情况，比如阻塞的问题，阻塞的原因会有很多种情况造成，如果当我们查询文档的时候发生了阻塞，那么就会影响到后面的操作，甚至无法对后面的操作进行响应。</p>
<p>我们可以通过监控很快速的找到到底是哪里出了问题，这样有助于我们快速定位所在的问题，从而得到解决。</p>
<p>Mongodb官方提供了三种用语<a href="https://docs.mongodb.com/manual/administration/monitoring/" target="_blank" rel="noopener">分析Mongodb</a>的方式：</p>
<ol>
<li>Mongodb自带的监控工具：用于提供数据库活动的实时报告</li>
<li>数据库命令：以更真实的情况返回数据库状态的统计信息</li>
<li>第三方平台托管监控</li>
</ol>
<h2 id="mongodb自带监控工具">Mongodb自带监控工具 <a href="#mongodb%e8%87%aa%e5%b8%a6%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7" class="anchor">🔗</a></h2><h3 id="mongostat">mongostat <a href="#mongostat" class="anchor">🔗</a></h3><p>mongostat是官方随同mongodb下载包中一同下载的，你可以找到安装目录或者解压目录进行使用。</p>
<p>我们可以通过<code>mongostat --help()</code>进行查询可用选项，也可以通过<a href="https://docs.mongodb.com/manual/reference/program/mongostat" target="_blank" rel="noopener">官方文档</a>进行查询。</p>
<p>Mongostat默认所返回的信息都是基于秒为单位，比如返回的insert指的是每秒插入数据库的对象数，而如果我们限制了返回时间，那么这个返回的结果是基于限制时间的平均值。</p>
<h4 id="-o-和--o">-O 和 -o <a href="#-o-%e5%92%8c--o" class="anchor">🔗</a></h4><p>这两个选项功能非常实用，按照正常的情况，Mongostat输出的报告会有很多我们不需要的列，所以我们可以通过<code>-o</code>来实现，这个选项设置后只会包含我们选择想要列，并且这个选项可以重新命名列的名字，除此之外<code>-o</code>和<code>-O</code>还可以添加一些服务器状态到报表中，可以参考<a href="https://docs.mongodb.com/manual/reference/command/serverStatus/#dbcmd.serverStatus" target="_blank" rel="noopener">ServerStatus</a>。</p>
<p>默认的mongostat输出的内容大概如下，并且每秒钟都会返回一个状态：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>insert query update delete getmore command flushes mapped vsize   res faults qrw arw net_in net_out conn                time
</span></span><span style="display:flex;"><span>    *0    *0     *0     *0       0     2|0       0     0B 2.39G 14.0M      0 0|0 0|0   286b   13.8k    1 Aug 24 17:34:17.615
</span></span><span style="display:flex;"><span>    *0    *0     *0     *0       0     1|0       0     0B 2.39G 14.0M      0 0|0 0|0   285b   13.7k    1 Aug 24 17:34:18.618
</span></span><span style="display:flex;"><span>    *0    *0     *0     *0       0     2|0       0     0B 2.39G 14.0M      0 0|0 0|0   286b   13.8k    1 Aug 24 17:34:19.617
</span></span><span style="display:flex;"><span>    *0    *0     *0     *0       0     1|0       0     0B 2.39G 14.0M      0 0|0 0|0   285b   13.8k    1 Aug 24 17:34:20.617 
</span></span></code></pre></div><p>下面的代码选项是重命名了insert列为cr，并只显示insert,query,update：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ mongostat --host localhost -o &#39;insert=cr,query,update&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>返回后的文档大概如下：
</span></span><span style="display:flex;"><span>cr query update
</span></span><span style="display:flex;"><span>*0    *0     *0
</span></span><span style="display:flex;"><span>*0    *0     *0
</span></span><span style="display:flex;"><span>*0    *0     *0
</span></span><span style="display:flex;"><span>*0    *0     *0 
</span></span></code></pre></div><p><code>-O</code>选项除了输出默认的列之外，可以重命名列名，还可以添加<a href="https://docs.mongodb.com/manual/reference/command/serverStatus/#dbcmd.serverStatus" target="_blank" rel="noopener">ServerStatus</a>一些字段输出到报表，比如插入文档的总数、主机地址、版本号等信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ mongostat --host localhost -O &#39;insert=cr,host,version&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>返回后的文档大概如下：
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cr query update delete getmore command flushes mapped vsize   res faults qrw arw net_in net_out conn                time cr            host version
</span></span><span style="display:flex;"><span>*0    *0     *0     *0       0     2|0       0     0B 2.39G 14.0M      0 0|0 0|0   286b   13.8k    2 Aug 24 17:51:34.031 *0 localhost:27040   3.4.6
</span></span><span style="display:flex;"><span>*0    *0     *0     *0       0     1|0       0     0B 2.39G 14.0M      0 0|0 0|0   285b   13.8k    2 Aug 24 17:51:35.032 *0 localhost:27040   3.4.6
</span></span><span style="display:flex;"><span>*0    *0     *0     *0       0     2|0       0     0B 2.39G 14.0M      0 0|0 0|0   286b   13.8k    2 Aug 24 17:51:36.032 *0 localhost:27040   3.4.6 
</span></span></code></pre></div><h4 id="--rowcount">--rowcount <a href="#--rowcount" class="anchor">🔗</a></h4><p><code>--rowcount</code>可以控制mongostat返回报表的频率，<code>--rowcount</code>接受的第一个参数为返回的次数，第二个参数是多少秒生成一次报表并返回。</p>
<p>比如我想每五秒返回一次报表，共返回十次：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ mongostat --rowcount 10 5 
</span></span></code></pre></div><h4 id="--discover">--discover <a href="#--discover" class="anchor">🔗</a></h4><p>监控副本集或分片的所有成员的统计信息。</p>
<h3 id="mongotop">mongotop <a href="#mongotop" class="anchor">🔗</a></h3><p><a href="https://docs.mongodb.com/manual/reference/program/mongotop/#bin.mongotop" target="_blank" rel="noopener">mongotop</a>可以监控数据库或者副本集的成员中哪个集合最为繁忙。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ mongotop --host localhost:27030
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>返回大概如下内容：
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                  ns    total    read    write    2017-08-25T20:50:06+08:00
</span></span><span style="display:flex;"><span>  admin.system.roles      0ms     0ms      0ms
</span></span><span style="display:flex;"><span>admin.system.version      0ms     0ms      0ms
</span></span><span style="display:flex;"><span>   local.startup_log      0ms     0ms      0ms
</span></span><span style="display:flex;"><span>local.system.replset      0ms     0ms      0ms
</span></span><span style="display:flex;"><span>           test.test      0ms     0ms      0ms 
</span></span></code></pre></div><h2 id="数据库命令">数据库命令 <a href="#%e6%95%b0%e6%8d%ae%e5%ba%93%e5%91%bd%e4%bb%a4" class="anchor">🔗</a></h2><p>数据库命令可以提供比Mongodb自带的监控工具提供更细微的信息，如果上面的方法无法帮你定位到问题所在，你可以试试下面的数据库命令来操作问题的所在。</p>
<h3 id="dbcurrentop">db.currentOp <a href="#dbcurrentop" class="anchor">🔗</a></h3><p><code>db.currentOp()</code>方法可以列出数据中所有正在进行的所有操作，我们可以通过返回的信息中几个比较重要的字段来找出问题所在。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>opid: 操作的ID号，可以通过db.killOp()方法来结束进程，就像系统命令中的PID。
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>active: 表示该操作当前是否还在运行。
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>secs_running：这个字段非常重要，我们可以根据此字段判断哪个操作进行了阻塞。
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>op：操作的类型，比如是查询，可能显示的是query。
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>desc：表示当前操作在日志中的前缀，我们可以根据此前缀在日志中快速定位。 
</span></span></code></pre></div><p>除此之外，我们还可以过滤参数，得到我们只想要的结果，下面是过滤其他不是当前正在查询的操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>db.currentOp({op: &#39;query&#39;}); 
</span></span></code></pre></div><h3 id="dbserverstatus">db.serverStatus <a href="#dbserverstatus" class="anchor">🔗</a></h3><p><code>db.serverStatus()</code>方法返回数据库状态的一般概述，详细说明磁盘使用情况，内存使用，连接，日记记录和索引访问。</p>
<h3 id="dbstats-dbteststats-rsstatus">db.stats db.test.stats rs.status <a href="#dbstats-dbteststats-rsstatus" class="anchor">🔗</a></h3><p><code>db.stats()</code>方法返回当前数据库的信息，其中<code>objects</code>就代表的是当前数据库所含的所有文档数量。</p>
<p><code>db.test.stats()</code>方法返回集合的信息</p>
<p><code>rs.status()</code>返回当前副本集的信息</p>
<h2 id="参考">参考 <a href="#%e5%8f%82%e8%80%83" class="anchor">🔗</a></h2><p><a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B00HLX035Q/ref=sr_1_1?ie=UTF8&amp;qid=1501597098&amp;sr=8-1&amp;keywords=mongodb" target="_blank" rel="noopener">MongoDB权威指南(第2版)</a></p>
<p><a href="https://docs.mongodb.com/manual/" target="_blank" rel="noopener">Mongodb Docs</a></p>

    </div>

    
        <div class="tags">
            
                <a href="https://wuyizhou.com/tags/%E6%9C%8D%E5%8A%A1%E5%92%8C%E8%BF%90%E7%BB%B4">服务和运维</a>
            
        </div>
    
    
    

</section>


    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/wyizhou" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="https://stackoverflow.com/users/11949960" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>stackoverflow</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-488.000000, -1163.000000)">
            <g id="stackoverflow" transform="translate(488.000000, 1163.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M42.0860128,53.5922927 L22.9745951,53.6011499 L22.9729497,49.5538824 L42.0835447,49.5440929 L42.0860128,53.5922927 L42.0860128,53.5922927 Z M55,30.6708298 L51.7306912,12 L47.7087256,12.6920259 L50.9775643,31.3628557 L55,30.6708298 L55,30.6708298 Z M42.5455518,44.3547147 L23.5156994,42.616026 L23.1410164,46.6470941 L42.1712214,48.3841513 L42.5455518,44.3547147 L42.5455518,44.3547147 Z M43.8009984,39.0731519 L25.3459811,34.1539179 L24.285633,38.0621508 L42.7419431,42.9819676 L43.8009984,39.0731519 L43.8009984,39.0731519 Z M46.2103463,34.4436411 L29.7494464,24.8164635 L27.6748215,28.3015328 L44.1365441,37.9292931 L46.2103463,34.4436411 L46.2103463,34.4436411 Z M50.2466504,31.6088756 L46.8745036,33.8883189 L36.106599,18.2318456 L39.4792159,15.9517031 L50.2466504,31.6088756 Z M45.3315807,40.2784283 L48.5799693,40.2784283 L48.5799693,60 L17,60 L17,40.2784283 L20.2648427,40.2784283 L20.2648427,56.8243495 L45.3315807,56.8243495 L45.3315807,40.2784283 Z" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="https://twitter.com/5yizhou" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="438.536px" height="438.536px" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536;"
	 xml:space="preserve">
<g>
	<path d="M414.41,24.123C398.333,8.042,378.963,0,356.315,0H82.228C59.58,0,40.21,8.042,24.126,24.123
		C8.045,40.207,0.003,59.576,0.003,82.225v274.084c0,22.647,8.042,42.018,24.123,58.102c16.084,16.084,35.454,24.126,58.102,24.126
		h274.084c22.648,0,42.018-8.042,58.095-24.126c16.084-16.084,24.126-35.454,24.126-58.102V82.225
		C438.532,59.576,430.49,40.204,414.41,24.123z M335.471,168.735c0.191,1.713,0.288,4.278,0.288,7.71
		c0,15.989-2.334,32.025-6.995,48.104c-4.661,16.087-11.8,31.504-21.416,46.254c-9.606,14.749-21.074,27.791-34.396,39.115
		c-13.325,11.32-29.311,20.365-47.968,27.117c-18.648,6.762-38.637,10.143-59.953,10.143c-33.116,0-63.76-8.952-91.931-26.836
		c4.568,0.568,9.329,0.855,14.275,0.855c27.6,0,52.439-8.565,74.519-25.7c-12.941-0.185-24.506-4.179-34.688-11.991
		c-10.185-7.803-17.273-17.699-21.271-29.691c4.947,0.76,8.658,1.137,11.132,1.137c4.187,0,9.042-0.76,14.56-2.279
		c-13.894-2.669-25.598-9.562-35.115-20.697c-9.519-11.136-14.277-23.84-14.277-38.114v-0.571
		c10.085,4.755,19.602,7.229,28.549,7.422c-17.321-11.613-25.981-28.265-25.981-49.963c0-10.66,2.758-20.747,8.278-30.264
		c15.035,18.464,33.311,33.213,54.816,44.252c21.507,11.038,44.54,17.227,69.092,18.558c-0.95-3.616-1.427-8.186-1.427-13.704
		c0-16.562,5.853-30.692,17.56-42.399c11.703-11.706,25.837-17.561,42.394-17.561c17.515,0,32.079,6.283,43.688,18.846
		c13.134-2.474,25.892-7.33,38.26-14.56c-4.757,14.652-13.613,25.788-26.55,33.402c12.368-1.716,23.88-4.95,34.537-9.708
		C357.458,149.793,347.462,160.166,335.471,168.735z"/>
</g>
</svg>

    </a>


</div>

    

    <div class="copyright">
    
        © Copyright 2023 Yizhou
    
    </div>

    
      <div class="powerby">
        Powered by <a href='http://www.gohugo.io/'>Hugo</a> Theme By <a href='https://github.com/nodejh/hugo-theme-mini'>nodejh</a>
      </div>
    
</footer>



  </body>
</html>
